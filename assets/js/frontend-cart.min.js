jQuery((function(t){"use strict";t(document).ready((function(){t(document.body).on("viwebpos_add_new_cart",(function(t,e=""){wiwebpos_atc_obj.add_new_cart(e)})),t(document.body).on("viwebpos_set_cart_customer",(function(t,e=null){wiwebpos_atc_obj.set_cart_customer(e)})),t(document.body).on("viwebpos_remove_all_cart_items",(function(){wiwebpos_atc_obj.remove_all_cart_items()})),t(document.body).on("viwebpos_add_to_cart",(function(t,e,o,a,r=""){wiwebpos_atc_obj.add_to_cart(e,o,a,r)})),t(document.body).on("viwebpos_add_order_note",(function(t,e="",o=null){wiwebpos_atc_obj.add_order_note(e,o)})),t(document.body).on("viwebpos_update_cart_quantity",(function(t,e,o,a=!0){wiwebpos_atc_obj.update_cart_quantity(e,o,a)})),t(document.body).on("viwebpos_update_cart_variation",(function(t,e,o){wiwebpos_atc_obj.update_cart_variation(e,o)}))})),window.wiwebpos_atc_obj={cart_calculate_totals:function(e=[],o=!0){let a=viwebpos_data;a.viwebposDB||(a.viwebposDB=indexedDB.open("viwebposDB"));let r=a.current_cart,_={},c={fees_total:0,fees_total_tax:0,items_subtotal:0,items_subtotal_tax:0,items_total:0,items_total_tax:0,total:0,shipping_total:0,shipping_tax_total:0,discounts_total:0};if(r.totals=a.set_cart_empty({}).default_totals,t(".viwebpos-wrap").addClass("viwebpos-wrap-loading"),("object"!=typeof a.filter_before_calculate_totals||!a.filter_before_calculate_totals)&&"object"==typeof viwebpos.filter_before_calculate_totals&&Object.values(viwebpos.filter_before_calculate_totals).length){a.filter_before_calculate_totals=["viwebpos_before_calculate_totals"];let t=Object.values(viwebpos.filter_before_calculate_totals);t.sort((function(t,e){return parseFloat(e.priority)-parseFloat(t.priority)})),t.map((function(t){a.filter_before_calculate_totals.push(`viwebpos_${t.type}_before_calculate_totals`)}))}if(a.filter_before_calculate_totals&&a.filter_before_calculate_totals.length){let _=t(document.body).triggerHandler(a.filter_before_calculate_totals.pop(),[r]);return _?"function"==typeof _.then?_.then((function(t){a.current_cart=t,setTimeout((function(t,e){a.cart_calculate_totals(t,e)}),100,e,o)})):(a.current_cart=_,setTimeout((function(t,e){a.cart_calculate_totals(t,e)}),100,e,o)):(a.current_cart=r,setTimeout((function(t,e){a.cart_calculate_totals(t,e)}),100,e,o)),!1}a.filter_before_calculate_totals=null;let s=viwebpos_price.shop_address;r.shop_address=s,t.each(r.cart_contents,(function(e,o){let a,r=o.data;a={key:e,object:o,tax_class:r.tax_class||"",taxable:"taxable"===r.tax_status||""!==o.custom,quantity:o.quantity,product:r,price_includes_tax:viwebpos_price.product_price_includes_tax,subtotal:0,subtotal_tax:0,subtotal_taxes:{},total:0,total_tax:0,taxes:{},tax_rates:{}},a.price=viwebpos_price_obj.add_number_precision_deep(parseFloat(o.quantity)*parseFloat(r.price)),viwebpos.wc_tax_enabled&&(a.tax_rates=t(document).triggerHandler("viwebpos_get_matched_tax_rates",[s.country,s.state,s.postcode,s.city,a.tax_class])),_[e]=a}));let i={};t.each(_,(function(e,o){o.price_includes_tax&&viwebpos_price.pos_tax_base&&(o=viwebpos_price_obj.adjust_non_base_location_price(o)),o.subtotal=o.price,viwebpos.wc_tax_enabled&&o.product.taxable&&(o.subtotal_taxes=o.price_includes_tax?t(document).triggerHandler("viwebpos_calc_inclusive_tax",[o.subtotal,o.tax_rates]):t(document).triggerHandler("viwebpos_calc_exclusive_tax",[o.subtotal,o.tax_rates]),Object.keys(o.subtotal_taxes).length&&(o.subtotal_tax=t.map(Object.values(o.subtotal_taxes),(function(t){return viwebpos_price.wc_tax_round_at_subtotal?t:viwebpos_round(t)})).reduce(((t,e)=>t+e))),o.price_includes_tax&&(o.subtotal=o.subtotal-o.subtotal_tax),t.each(o.subtotal_taxes,(function(t,e){i[t]||(i[t]=0),i[t]+=viwebpos_price_obj.remove_number_precision(viwebpos_round(e))}))),r.cart_contents[e].line_tax_data={subtotal:viwebpos_price_obj.remove_number_precision_deep(o.subtotal_taxes)},r.cart_contents[e].line_subtotal=viwebpos_price_obj.remove_number_precision(o.subtotal),r.cart_contents[e].line_subtotal_tax=viwebpos_price_obj.remove_number_precision(o.subtotal_tax)})),Object.keys(_).length&&(c.items_subtotal=t.map(_,(function(t){return viwebpos_price.wc_tax_round_at_subtotal?t.subtotal:viwebpos_round(t.subtotal)})).reduce(((t,e)=>viwebpos_price.wc_tax_round_at_subtotal?t+e:viwebpos_round(t,0)+viwebpos_round(e,0)))),Object.keys(i).length&&(c.items_subtotal_tax=viwebpos_round(t.map(Object.values(i),(function(t){return t})).reduce(((t,e)=>t+e)))),r.totals.subtotal=viwebpos_price_obj.remove_number_precision(c.items_subtotal),r.totals.subtotal_tax=c.items_subtotal_tax;let n=r.applied_coupons?Object.values(r.applied_coupons):{},u=Object.values(_),l={},p=t(document).triggerHandler("viwebpos_cart_get_coupons",[n,r,r.totals.subtotal+r.totals.subtotal_tax]);p&&(n=p),u.length||(n={}),n.length&&(t.each(n,(function(e,o){switch(o.type){case"fixed_product":o.sort=1;break;case"percent":o.sort=2;break;case"fixed_cart":o.sort=3;break;default:o.sort=0}o.sort=t(document.body).triggerHandler("viwebpos_woocommerce_coupon_sort",[o.sort,o])||o.sort})),n.sort((function(t,e){return t.sort===e.sort?t.limit_usage_to_x_items===e.limit_usage_to_x_items?t.amount===e.amount?t.id-e.id:t.amount-e.amount:t.limit_usage_to_x_items-e.limit_usage_to_x_items:t.sort-e.sort}))),u.length&&u.sort((function(t,e){return t.price*t.quantity-e.price*t.quantity})),t.each(n,(function(e,o){l[o.coupon_code]||(l[o.coupon_code]={},t.each(u,(function(t,e){e&&e.key&&(l[o.coupon_code][e.key]=0)})))})),Object.keys(l).length&&t.each(n,(function(e,o){let _=[];switch(t.each(u,(function(e,r){let c={...r};return c.quantity<=0||0===viwebpos_price_obj.get_discounted_price_in_cents(c,l)||(!a.coupon_is_valid_for_product(r.product,r.object,o)&&t.inArray(o.type,viwebpos.wc_get_cart_coupon_types)<0||void _.push(c))})),o.type){case"percent":case"fixed_product":case"fixed_cart":l=t(document.body).triggerHandler("viwebpos_apply_coupon",[l,o,_,o.type]);break;default:a.current_cart=r,l=t(document.body).triggerHandler("viwebpos_apply_coupon",[l,o,_,"custom"])}}));let d={},b=viwebpos_price_obj.cart_get_discounts_by_coupon(l,!0);viwebpos.wc_tax_enabled&&t.each(l,(function(e,o){d[e]=0,t.each(o,(function(o,a){let r=_[o];if(r&&r.product.taxable){let o=r.price_includes_tax?t(document).triggerHandler("viwebpos_calc_inclusive_tax",[a,r.tax_rates]):t(document).triggerHandler("viwebpos_calc_exclusive_tax",[a,r.tax_rates]);o=Object.values(o).length?Object.values(o).reduce(((t,e)=>t+e)):0,d[e]+=o,r.price_includes_tax&&(b[e]-=o)}}))}));let m=viwebpos_price_obj.get_discounts_by_item(l,!0),v=d;v&&Object.values(v).length&&(r.totals.discounts_tax_total=Object.values(v).reduce(((t,e)=>t+e))),m&&Object.values(m).length&&(r.totals.discounts_total=viwebpos_price.product_price_includes_tax?Object.values(m).reduce(((t,e)=>t+e))-r.totals.discounts_tax_total:Object.values(m).reduce(((t,e)=>t+e))),r.totals.discount_total=viwebpos_price_obj.remove_number_precision_deep(r.totals.discounts_total),r.totals.discount_tax=viwebpos_price_obj.remove_number_precision_deep(r.totals.discounts_tax_total),r.coupon_discount_totals=viwebpos_price_obj.remove_number_precision_deep(b),r.coupon_discount_tax_totals=viwebpos_price_obj.remove_number_precision_deep(d);let w={};t.each(_,(function(e,o){o.total=viwebpos_price_obj.get_discounted_price_in_cents(o,l),o.total_tax=0,o.total=t(document.body).triggerHandler("viwebpos_woocommerce_get_discounted_price")||o.total,viwebpos.wc_tax_enabled&&o.product.taxable&&(o.taxes=o.price_includes_tax?t(document).triggerHandler("viwebpos_calc_inclusive_tax",[o.total,o.tax_rates]):t(document).triggerHandler("viwebpos_calc_exclusive_tax",[o.total,o.tax_rates]),Object.keys(o.taxes).length&&(o.total_tax=t.map(Object.values(o.taxes),(function(t){return viwebpos_price.wc_tax_round_at_subtotal?t:viwebpos_round(t)})).reduce(((t,e)=>t+e))),o.price_includes_tax&&(o.total=o.total-o.total_tax),t.each(o.taxes,(function(t,e){w[t]||(w[t]=0),w[t]+=viwebpos_price_obj.remove_number_precision_deep(viwebpos_round(e,0))}))),r.cart_contents[e].line_tax_data.total=viwebpos_price_obj.remove_number_precision_deep(o.taxes),r.cart_contents[e].line_total=viwebpos_price_obj.remove_number_precision(o.total),r.cart_contents[e].line_tax=viwebpos_price_obj.remove_number_precision(o.total_tax)})),Object.keys(_).length&&(c.items_total=t.map(_,(function(t){return viwebpos_price.wc_tax_round_at_subtotal?t.total:viwebpos_round(t.total)})).reduce(((t,e)=>viwebpos_price.wc_tax_round_at_subtotal?t+e:viwebpos_round(t,0)+viwebpos_round(e,0))),c.items_total_tax=t.map(_,(function(t){return viwebpos_price.wc_tax_round_at_subtotal?t.total_tax:viwebpos_round(t.total_tax)})).reduce(((t,e)=>t+e))),r.totals.cart_contents_total=viwebpos_price_obj.remove_number_precision(c.items_total),r.totals.cart_contents_taxes=w,Object.keys(r.totals.cart_contents_taxes).length&&(r.totals.cart_contents_tax=viwebpos_round(t.map(Object.values(r.totals.cart_contents_taxes),(function(t){return viwebpos_price.wc_tax_round_at_subtotal?t:viwebpos_round(t)})).reduce(((t,e)=>t+e))));let g={},f={},x=0,h=t(document.body).triggerHandler("viwebpos_cart_get_fees",[{},r,viwebpos_price_obj.remove_number_precision(c.items_total)+r.totals.cart_contents_tax]);t.each(h,(function(e,o){let r={object:null,tax_class:"",taxable:!1,total_tax:0,taxes:{}};if(r.object=o,r.tax_class=r.object.tax_class,r.taxable=r.object.taxable,r.total=viwebpos_price_obj.add_number_precision_deep(r.object.amount),r.total<0){let t=-1*viwebpos_round(c.items_total+x);r.total<t&&(r.total=t)}if(x+=r.total,viwebpos.wc_tax_enabled)if(r.total<0&&"pos_discount"!==r.object.id){let e=viwebpos_price_obj.cart_get_tax_class_costs(_,g,h),o=Object.keys(e).length?Object.values(e).reduce(((t,e)=>t+e)):0;o&&t.each(e,(function(e,a){if("non-taxable"===e)return!0;let _=a/o,c=r.total*_,i=t(document).triggerHandler("viwebpos_calc_exclusive_tax",[c,t(document).triggerHandler("viwebpos_get_matched_tax_rates",[s.country,s.state,s.postcode,s.city,e])]),n=[r.taxes,i];r.taxes=viwebpos_price_obj.array_merge_recursive_numeric(n)}))}else r.object.taxable&&(r.taxes=t(document).triggerHandler("viwebpos_calc_exclusive_tax",[r.total,t(document).triggerHandler("viwebpos_get_matched_tax_rates",[s.country,s.state,s.postcode,s.city,r.tax_class])]));r.taxes=t(this).triggerHandler("viwebpos_woocommerce_cart_totals_get_fees_from_cart_taxes",r.taxes,r,a)||r.taxes,Object.keys(r.taxes).length&&(r.total_tax=Object.values(r.taxes).reduce(((t,e)=>parseFloat(t)+parseFloat(e)))),r.object.total=viwebpos_price_obj.remove_number_precision_deep(r.total),r.object.tax_data=viwebpos_price_obj.remove_number_precision_deep(r.taxes),r.object.tax=viwebpos_price_obj.remove_number_precision_deep(r.total_tax),f[e]=r})),Object.keys(f).length&&(c.fees_total=t.map(Object.values(f),(function(t){return viwebpos_price.wc_tax_round_at_subtotal?t.total:viwebpos_round(t.total)})).reduce(((t,e)=>t+e)),c.fees_total_tax=t.map(Object.values(f),(function(t){return viwebpos_price.wc_tax_round_at_subtotal?t.total_tax:viwebpos_round(t.total_tax)})).reduce(((t,e)=>t+e))),r.fees={},t.each(f,(function(t,e){r.fees[t]=e.object})),r.totals.fee_total=viwebpos_price_obj.remove_number_precision_deep(c.fees_total),r.totals.fee_tax=viwebpos_price_obj.remove_number_precision_deep(c.fees_total_tax),c.total=viwebpos_round(viwebpos_price_obj.remove_number_precision(c.items_total)+r.totals.fee_total+r.totals.cart_contents_tax+r.totals.fee_tax),r.totals.total_tax=r.totals.cart_contents_tax+r.totals.fee_tax,r.totals.total=Math.max(0,t(document.body).triggerHandler("viwebpos_calculated_total",[c.total,r])||c.total),r=t(document.body).triggerHandler("viwebpos_after_calculate_totals",[r])||r,a.current_cart=r,void 0!==a.current_cart.key&&a.current_cart.key||(a.current_cart.key=viwebpos.cashier_id+"_"+Date.now()),a.cart_refresh_payments(),e.length&&t(document.body).trigger("villatheme_show_messages",[e]),o&&t(document.body).trigger("viwebpos_refresh_cart")},cart_data_validate:function(e,o,a=[]){let r=viwebpos_data;if(!r.current_cart&&e&&(r.current_cart=e),!Object.keys(r.current_cart.cart_contents).length)return o&&r.current_cart.id?(r.current_cart.coupon_discount_tax_totals={},r.current_cart.coupon_discount_totals={},r.current_cart.totals=r.set_cart_empty({}).default_totals,r.current_cart.payments.is_paid||(r.current_cart.payments=r.set_cart_empty({}).payments),t(document.body).trigger("viwebpos_refresh_cart")):(t(document.body).trigger("viwebpos-bill-of-sale-refresh-bill-tabs"),t(document.body).trigger("viwebpos-bill-of-sale-get-html")),void 0===r.syncing_pos_data&&(r.syncing_pos_data=!1,t(document.body).trigger("viwebpos-sync-online-data",["pos"])),!1;r.viwebposDB||(r.viwebposDB=indexedDB.open("viwebposDB"));let _=r.viwebposDB.result,c={},s=[],i=Object.keys(e.cart_contents).length,n="",u={},l=0,p=i;e.applied_coupons&&Object.keys(e.applied_coupons).length&&(l=Object.keys(e.applied_coupons).length);(async function(){if(r.data_prefix.customers_current_page&&r.data_prefix.customers_total_page&&e.customer.id){let o=[];await new Promise((function(t){let a=e.customer.id;if(!a)return t(o),!1;let r=_.transaction("customers","readonly").objectStore("customers");if(!r)return t(o),!1;r.get(a).onsuccess=function(e){e.target.result||o.push(a),t(o)}})),o.length&&await new Promise((function(e){r.run_request({type:"post",url:viwebpos.viwebpos_ajax_url.toString().replace("%%endpoint%%","viwebpos_customer_search_data"),data:t.param({user_ids:o,viwebpos_nonce:viwebpos.nonce}),success:function(t){viwebpos_data.puts(_.transaction("customers","readwrite").objectStore("customers"),t.data||{}),e(s)},error:function(t){e(s)}})}))}if(await new Promise((function(t){let o=e.customer.id;if(!o)return t(n,s),!1;let a=_.transaction("customers","readonly").objectStore("customers");if(!a)return t(n,s),!1;a.get(o).onsuccess=function(e){e.target.result?n=e.target.result:s.push(viwebpos.cart_customer_invalid),t(n,s)}})),r.data_prefix.products_current_page&&r.data_prefix.products_total_page){let o=[];await new Promise((function(a){let r=_.transaction("products","readonly").objectStore("products"),c=i;t.each(e.cart_contents,(function(t,e){let _=e.variation_id?e.variation_id:e.product_id;if(e.quantity<=0||"custom"===_||e.order_line_item)return c--,c||a(o),!0;r.get(_).onsuccess=function(t){let e=t.target.result;c--,e||o.push(_),c||a(o)}}))})),o.length&&await new Promise((function(e){r.run_request({type:"post",url:viwebpos.viwebpos_ajax_url.toString().replace("%%endpoint%%","viwebpos_product_search_data"),data:t.param({product_ids:o,viwebpos_nonce:viwebpos.nonce}),success:function(t){viwebpos_data.puts(_.transaction("products","readwrite").objectStore("products"),t.data||{}),e(s)},error:function(t){e(s)}})}))}if(await new Promise((function(o){let a=_.transaction("products","readonly").objectStore("products");t.each(e.cart_contents,(function(t,e){let r=e.variation_id?e.variation_id:e.product_id;return e.quantity<=0?(i--,i||o(c,s),!0):"custom"===r||e.order_line_item?(c[t]=e,i--,i||o(c,s),!0):void(a.get(r).onsuccess=function(a){let r=a.target.result;if(i--,!r)return s.push(viwebpos.cart_item_invalid),i||o(c,s),!1;r.is_purchasable?e.data_hash&&e.data_hash===wiwebpos_atc_obj.get_cart_item_data_hash(r)?(e.data=r,c[t]=e,r.is_in_stock?null!==r.stock&&parseFloat(r.stock)<parseFloat(e.quantity)&&s.push(viwebpos.cart_item_not_enough_stock_message.replace("{product_name}",r.name).replace("{product_quantity}",r.stock??0)):s.push(viwebpos.cart_item_not_enough_stock_message.replace("{product_name}",r.name).replace("{product_quantity}",0))):s.push(viwebpos.cart_item_removed_message1.replace("{product_name}",r.name)):s.push(viwebpos.cart_item_removed_message.replace("{product_name}",r.name)),i||o(c,s)})}))})),l&&Object.keys(c).length<p&&(r.current_cart.customer=n,r.current_cart.cart_contents=c,await r.cart_calculate_totals([],!1)),r.data_prefix.coupons_current_page&&r.data_prefix.coupons_total_page&&l){let o=[];await new Promise((function(a){if(!l)return a(o),!1;let r=_.transaction("coupons","readonly").objectStore("coupons"),c=l;if(!r)return a(o),!1;t.each(e.applied_coupons,(function(t,e){r.get(t).onsuccess=function(t){c--,t.target.result||o.push(e.id),c||a(o)}}))})),o.length&&await new Promise((function(e){r.run_request({type:"post",url:viwebpos.viwebpos_ajax_url.toString().replace("%%endpoint%%","viwebpos_coupon_search_data"),data:t.param({ids:o,viwebpos_nonce:viwebpos.nonce}),success:function(t){viwebpos_data.puts(_.transaction("coupons","readwrite").objectStore("coupons"),t.data||{}),e(s)},error:function(t){e(s)}})}))}let o={},a="";if(await new Promise((function(c){if(!l)return c(u,s),!1;let i=_.transaction("coupons","readonly").objectStore("coupons");if(!i)return c(u,s),!1;let p=[];n&&(p.push(n.email),n.billing_address.email&&n.billing_address.email!==n.email&&p.push(n.billing_address.email),a=n.id),t.each(e.applied_coupons,(function(e,_){i.get(e).onsuccess=function(e){let i=e.target.result;if(l--,!i)return s.push(viwebpos_text.error_order_invalid_coupon1.replace("%1$s",_.coupon_code)),l||c(u,s),!1;if(!r.is_coupon_emails_allowed(p,i.email||[]))return s.push(viwebpos_text.error_order_invalid_coupon2.replace("%1$s",i.coupon_code)),l||c(u,s),!1;if(!r.is_coupon_valid(i,i.coupon_code,!1))return s.push(viwebpos_text.error_order_invalid_coupon1.replace("%1$s",i.coupon_code)),l||c(u,s),!1;let n=parseInt(i.usage_limit_per_user);a&&(t(document.body).triggerHandler("viwebpos_woocommerce_coupon_validate_user_usage_limit",[n])||n)>0?o[i.coupon_code]=i:u[i.coupon_code]=i,l||c(u,s)}}))})),Object.keys(o).length&&a)if(r.data_prefix.orders_current_page&&r.data_prefix.orders_total_page)await new Promise((function(e){r.run_request({type:"post",url:viwebpos.viwebpos_ajax_url.toString().replace("%%endpoint%%","viwebpos_coupon_check_usage_limit_per_user"),data:t.param({customer_id:a,coupons:Object.keys(o),viwebpos_nonce:viwebpos.nonce}),success:function(t){if(t.message&&t.message.length&&s.concat(t.message),t.usage)for(let e in t.usage){let a=t.usage[e];o[a]&&(u[a]=o[a])}e(u,s)},error:function(t){e(u,s)}})}));else{let r=_.transaction("orders","readonly").objectStore("orders");await new Promise((function(_){t.each(o,(function(t,o){let c=parseInt(o.usage_limit_per_user),i=0;r.index("customer_id").openCursor(parseInt(a)).onsuccess=function(a){let r=a.target.result;return r?e.order_data&&e.order_data.id===r.value.id||"cancelled"===r.value.status||r.value.pos_update_to_order?(r.continue(),!0):(r.value.coupon_lines&&r.value.coupon_lines[t]&&i++,void r.continue()):(i>=c?s.push(viwebpos_text.error_order_invalid_coupon1.replace("%1$s",o.coupon_code)):u[t]=o,_(u,s),!1)}}))}))}})().then((function(){r.current_cart.customer=n,r.current_cart.cart_contents=c,r.current_cart.applied_coupons=u,s&&s.length?(t.each(s,(function(t,e){a.push({message:e,status:["error","cart-notice"]})})),r.cart_calculate_totals(a)):o?r.cart_calculate_totals(a):t(document.body).trigger("viwebpos-bill-of-sale-get-html",[r.current_cart])}))},update_cart_variation:function(e,o){if(!e||!o||!Object.keys(o).length)return t(document.body).trigger("villatheme_show_message",[viwebpos.error_title,["error","update-variation"],viwebpos_text.error_change_variation,!0,4500]),!1;let a=viwebpos_data;if(!a.current_cart.cart_contents[e])return t(document.body).trigger("villatheme_show_message",[viwebpos.error_title,["error","update-variation"],viwebpos_text.error_change_variation,!0,4500]),!1;let r=a.current_cart.cart_contents[e];r.variation_id||r.product_id||t(document.body).trigger("villatheme_show_message",[viwebpos.error_title,["error","update-variation"],viwebpos_text.error_change_variation,!0,4500]),a.viwebposDB||(a.viwebposDB=indexedDB.open("viwebposDB"));let _,c=a.viwebposDB.result.transaction("products","readonly").objectStore("products"),s={};t.each(o,(function(t,e){s[t.replace("attribute_","")]=e})),c.index("parent_id").openCursor(r.product_id).onsuccess=function(c){let i=c.target.result;if(!i)return _||t(document.body).trigger("villatheme_show_message",[viwebpos.error_title,["error","update-variation"],viwebpos.no_matching_variations_text,!0,4500]),!1;if(wiwebpos_atc_obj.find_matching_variations(s,i.value)){_=i.value;let c=a.current_cart.cart_contents[e].item_serial;return delete a.current_cart.cart_contents[e],t(document.body).trigger("viwebpos_add_to_cart",[_,o,r.quantity,c]),!1}i.continue()}},update_cart_quantity:function(e,o=1,a=!0){if(!e)return!1;let r=viwebpos_data;if(!r.current_cart.cart_contents[e])return!1;if(!((o=parseFloat(o))>0))return delete r.current_cart.cart_contents[e],t(document.body).trigger("viwebpos_cart_data_validate",[r.current_cart,!0]),!1;{let a=r.current_cart.cart_contents[e].data;if(a.is_sold_individually&&(o=1),null!==a.stock){let _=parseFloat(a.stock);if(r.current_cart.cart_contents[e].order_line_item&&r.current_cart.cart_contents[e].order_line_item.quantity&&(_+=parseFloat(r.current_cart.cart_contents[e].order_line_item.quantity)),_<o){let e=viwebpos.not_enough_stock_message.replace("{product_name}",a.name).replace("{product_quantity}",_);return t(document.body).trigger("villatheme_show_message",[viwebpos.error_title,["error","product-adding"],e,!0,4500]),t(document.body).trigger("viwebpos-bill-of-sale-get-html",[r.current_cart]),!1}}r.current_cart.cart_contents[e].quantity=o}a&&r.cart_calculate_totals()},set_cart_customer:function(e=null){let o=e;"object"==typeof e&&e&&e.id&&e.username||(o=""),viwebpos_data.current_cart.customer=o,"undefined"!=typeof viwebpos_redis||viwebpos_data.current_cart.applied_coupons&&Object.keys(viwebpos_data.current_cart.applied_coupons).length?t(document.body).trigger("viwebpos_cart_data_validate",[viwebpos_data.current_cart,!0]):t(document.body).trigger("viwebpos_refresh_cart",["checkout"])},remove_all_cart_items:function(){viwebpos_data.current_cart=viwebpos_data.set_cart_empty(viwebpos_data.current_cart),t(document.body).trigger("viwebpos_refresh_cart")},add_to_cart:function(e,o,a=1,r=""){if(!e||a<=0)return!1;let _=e.id,c=0,s={},i=[];switch(e.type){case"variation":c=_,_=e.parent_id;break;case"custom":s.custom={name:e.name,price:e.price,taxable:e.taxable}}s=t(document.body).triggerHandler("viwebpos_add_cart_item_data",[e,s,_,c,a])||s;let n=wiwebpos_atc_obj.generate_cart_id(_,c,o,s),u=viwebpos_data.current_cart.cart_contents;"object"==typeof u&&Object.keys(u).length||(u={});let l=n&&u[n]?n:"",p=Object.keys(u).length;if(!l&&5===p)return t(document.body).trigger("villatheme_show_message",[viwebpos.error_title,["error","product-adding"],viwebpos.maximum_atc_message,!0,4500]),!1;if(e.is_sold_individually){if(a=1,l&&parseFloat(viwebpos_data.current_cart[l].quantity)>0)return t(document.body).trigger("villatheme_show_message",[viwebpos.error_title,["error","product-adding"],viwebpos.cannot_add_another_message.replace("{product_name}",e.name),!0,4500]),!1}if(!e.is_in_stock)return t(document.body).trigger("villatheme_show_message",[viwebpos.error_title,["error","product-adding"],viwebpos.out_of_stock_message.replace("{product_name}",e.name),!0,4500]),r&&t(document.body).trigger("viwebpos-bill-of-sale-get-html",[viwebpos_data.current_cart]),!1;if(a+=l&&u[l].quantity||0,null!==e.stock&&parseFloat(e.stock)<a){let o=viwebpos.not_enough_stock_message.replace("{product_name}",e.name);return o.replace("{product_quantity}",e.stock),t(document.body).trigger("villatheme_show_message",[viwebpos.error_title,["error","product-adding"],o,!0,4500]),!1}if(l)u[l].quantity=a,viwebpos_data.current_cart.cart_contents=u,i.push({message:viwebpos.add_to_cart_message.replace("{product_name}",e.name),status:["success","cart-notice"]});else{l=n;let p=s;if(p.item_serial=r||(new Date).getTime(),p.key=l,p.product_id=_||"custom",p.variation_id=c,p.variation=o,p.quantity=a,p.data=e,p.data_hash="custom"!==e.type?wiwebpos_atc_obj.get_cart_item_data_hash(e):"",u[l]=t(document.body).triggerHandler("viwebpos_add_cart_item",[p])||p,viwebpos_data.current_cart.cart_contents=u,i.push({message:viwebpos.add_to_cart_message.replace("{product_name}",e.name),status:["success","cart-notice"]}),t(document.body).trigger("viwebpos_added_to_cart",[l,_,a,c,o,s]),viwebpos_data.current_cart.applied_coupons&&Object.keys(viwebpos_data.current_cart.applied_coupons).length)return t(document.body).trigger("viwebpos_cart_data_validate",[viwebpos_data.current_cart,!0,i]),!1}viwebpos_data.cart_calculate_totals(i)},add_order_note:function(e="",o=null){null===o?viwebpos_data.current_cart.order_note=e.toString():viwebpos_data.current_cart.cart_contents[o]&&(viwebpos_data.current_cart.cart_contents[o].item_note=e),t(document.body).trigger("viwebpos_refresh_cart",[!1])},find_matching_variations:function(t,e){if(!(e.id&&"variation"===e.type&&e.attributes&&Object.keys(e.attributes).length&&t))return!1;let o=Object.getOwnPropertyNames(e.attributes),a=Object.getOwnPropertyNames(t);if(o.length!==a.length)return!1;for(let a=0;a<o.length;a++){let r=o[a],_=t[r],c=e.attributes[r];if(void 0!==_&&void 0!==c&&0!==_.length&&0!==c.length&&_!==c)return!1}return!0},set_cart_empty:function(t){return t||(t={}),t.order_data&&delete t.order_data,void 0!==t.key||t.key||(t.key=viwebpos.cashier_id+"_"+Date.now()),t.cart_contents={},t.fees={},t.pos_shipping={},t.pos_shipping_address="",t.pos_discount={},t.applied_coupons={},t.coupon_discount_totals={},t.coupon_discount_tax_totals={},t.order_note="",t.customer="",t.payments={is_paid:!1,is_paid_title:"",paid:{cash:0},total_paid:0,change:0},t.default_totals={subtotal:0,subtotal_tax:0,discount_total:0,discount_tax:0,cart_contents_total:0,cart_contents_tax:0,cart_contents_taxes:{},shipping_total:0,shipping_tax:0,shipping_taxes:{},fee_total:0,fee_tax:0,fee_taxes:{},total:0,total_tax:0},t.totals=t.default_totals,t},get_cart_item_data_hash:function(e){let o={type:e.type||"custom",attributes:e.attributes||""};return o=t(document.body).triggerHandler("viwebpos_cart_item_data_to_validate",[o,e])||o,wiwebpos_atc_obj.create_hash(t.param(o))},create_hash:function(t){let e=0;if(0===t.length)return e;t="_"+t;for(let o=0;o<t.length;o++)e=(e<<5)-e+t.charCodeAt(o),e&=e;return e.toString()},generate_cart_id:function(e,o=0,a={},r={}){let _=[e];o&&0!==o&&_.push(o);let c="";t.each(a,(function(t,e){c+=t.trim()+e.trim()})),c&&_.push(c);let s="";return t.each(r,(function(e,o){"object"==typeof o&&(o=t.param(o)),s+=e.trim()+o.toString().trim()})),s&&_.push(s),wiwebpos_atc_obj.create_hash(_.join("_"))}}}));