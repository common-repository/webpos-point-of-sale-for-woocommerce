jQuery(document).ready((function(e){"use strict";let i;function o(i,o=1,s="",t=!1){e(".viwebpos-wrap").removeClass("viwebpos-wrap-loading");let l=e(".viwebpos-orders-container"),r=e(".viwebpos-orders-list"),a=e(".viwebpos-search-input.viwebpos-search-order"),d="",p=!1;if(r.length||(e(".viwebpos-orders-list-wrap").prepend('<div class="viwebpos-orders-list"></div>'),r=e(".viwebpos-orders-list")),!i)return void r.html('<div class="viwebpos-search-order-empty">'+(viwebpos.search_order_empty||"No order found")+"</div>");l.find(".viwebpos-search-order-more").remove(),1!==o||t||(r.html(""),l.find(".viwebpos-order-details-wrap").html("")),i.length&&i.at(-1).next_page&&(p=i.at(-1).next_page,a.data("page",p),i.pop());let n="all"===e(".viwebpos-order-type").dropdown("get value");if(e.each(i,(function(e,i){t||(d=""),d+='<div class="viwebpos-search-order-row" data-id="'+i.id+'">',d+='<div class="viwebpos-search-order-details" >',d+='<div class="viwebpos-search-order-name">',d+='<div class="viwebpos-search-order-id">'+viwebpos.order_title+" #<span>"+i.id,n&&(d+=`<span class="viwebpos-search-order-type viwebpos-search-order-type-${i.type}">${viwebpos_text.order_types[i.type]}</span>`),d+="</span></div>",d+='<div class="viwebpos-search-order-date"><span><i class="clock outline icon"></i></span>'+i.created_at+"</div>",i.email||i.customer_id?((i.billing_address.last_name||i.billing_address.first_name)&&(d+='<div class="viwebpos-search-order-user"><i class="user outline icon"></i>'+i.billing_address.first_name+" "+i.billing_address.last_name+"</div>"),(i.email||i.billing_address.email)&&(d+='<div class="viwebpos-search-order-user"><i class="envelope outline icon"></i>'+(i.email||i.billing_address.email)+"</div>")):d+='<div class="viwebpos-search-order-user"><i class="user outline icon"></i>'+viwebpos.guest_title+"</div>",d+="</div>",d+='<div class="viwebpos-search-order-count">',d+='<div class="viwebpos-search-order-price">'+viwebpos_get_price_html(i.total,null,null,null,null,i.currency_symbol)+"</div>",d+='<div class="viwebpos-search-order-status">'+i.status+"</div>",1===i.line_items.length?d+='<div class="viwebpos-search-order-items">'+i.line_items.length+" item</div>":d+='<div class="viwebpos-search-order-items">'+i.line_items.length+" items</div>",d+="</div>",d+='<div class="viwebpos-order-arrow"><i class="angle right icon"></i></div>',d+="</div>",d+="</div>",t||r.append(d)})),t&&r.append(d),p){let e='<div class="viwebpos-search-order-more"><span class="vi-ui teal button">'+(viwebpos.load_more_title||"Load more")+"</span></div>";r.append(e)}t||setTimeout((function(){!function(i){let o=e(".viwebpos-orders-list .viwebpos-search-order-row:first-child");if(!i)return e(".viwebpos-order-details-wrap").html(""),!1;"function"==typeof i.then?i.then((function(i){e(document.body).trigger("viwebpos_order_details",[i])})):e(document.body).trigger("viwebpos_order_details",[i]);e(".viwebpos-order-active").removeClass("viwebpos-order-active"),o.addClass("viwebpos-order-active")}(i[0])}),200),d||r.html('<div class="viwebpos-search-order-empty">'+(viwebpos.search_order_empty||"No order found")+"</div>")}e(document.body).on("viwebpos-orders-load",(function(){if(!e(".viwebpos-header-search-order").length){let i='<div class="viwebpos-header-search viwebpos-header-search-order">';i+='<div class="vi-ui right action labeled input">',i+='<div class="viwebpos-header-search-icon"><i class="icon search"></i></div>',i+='<input type="text" class="viwebpos-search-input viwebpos-search-order" placeholder="'+viwebpos.search_order+'">',i+='<select class="vi-ui dropdown viwebpos-order-type">',e.each(viwebpos_text.order_types,(function(e,o){i+=`<option value="${e}">${o}</option>`})),i+="</select>",i+="</div>",e(".viwebpos-header-search-wrap").html(i),e(".viwebpos-order-type").dropdown("set selected",e(".viwebpos-header-action-icons-wifi-offline").length?"offline":"online_pos"),e(".viwebpos-order-type").dropdown({onChange:function(i){e(".viwebpos-search-order").val(null),e(document.body).trigger("viwebpos_order_refresh_html")}})}if(!e(".viwebpos-orders-container").length){let i='<div class="viwebpos-container-element viwebpos-orders-container"><div class="viwebpos-orders-list-wrap">';i+='<div class="viwebpos-orders-list"></div></div><div class="viwebpos-order-details-wrap">',i+='<div class="viwebpos-order-detail-header"></div>',i+='<div class="viwebpos-order-detail-products"></div>',i+='<div class="viwebpos-order-detail-totals"></div></div>',i+="</div>",e(".viwebpos-container-wrap").append(i)}setTimeout((function(){e(document.body).trigger("viwebpos-frontend-loaded",["orders"]),e(document.body).trigger("viwebpos_order_refresh_html")}),100)})),e(document).on("click keyup",".viwebpos-search-order",(function(i){i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation();let o=e(this),s=o.val();if(s===(o.data("old_key")||""))return!1;o.data("page",1),o.data("old_key",s),e(document.body).trigger("viwebpos_order_refresh_html",[s])})),e(document).on("click",".viwebpos-search-order-row",(function(i){i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation();e(this);let o=e(this).data("id"),s=e(".viwebpos-order-details-wrap").data("id")?e(".viwebpos-order-details-wrap").data("id"):"";if(s&&s==o)return!1;if(!o)return!1;let t=e(document.body).triggerHandler("viwebpos_search_data",["order",o,5,1]);"function"==typeof t.then?t.then((function(i){e(document.body).trigger("viwebpos_order_details",[i])})):e(document.body).trigger("viwebpos_order_details",[t]),e(".viwebpos-order-active").removeClass("viwebpos-order-active"),e(this).addClass("viwebpos-order-active")})),e(document).on("click",".viwebpos-search-order-more",(function(i){i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation();let o=e(".viwebpos-search-input.viwebpos-search-order"),s=o.data("page")?o.data("page"):"",t=o.data("old_key")||"";if(!s)return!1;e(document.body).trigger("viwebpos_order_refresh_html",[t,s,void 0,!0])})),e(document.body).on("viwebpos_order_details",(function(i,o){let s,t="";s=e(".viwebpos-order-details-wrap"),s.html(""),s.data("id",o.id),o||s.html('<div class="viwebpos-order-details-empty">'+(viwebpos.search_order_empty||"No order found")+"</div>");let l=o.billing_address.first_name+" "+o.billing_address.last_name;o.billing_address.first_name||o.billing_address.last_name||(l=o.billing_address.phone,o.billing_address.phone||(l=o.email,o.email||(l=viwebpos.guest_title)));let r=parseFloat(o.total_discount)>0?"- ":"";t+='<div class="viwebpos-order-detail-header"><span class="viwebpos-order-detail-header-order-id">'+viwebpos.order_title+" #"+o.id,t+='</span><span class="viwebpos-order-detail-header-customer"><i class="user outline icon"></i>'+l+"</span></div>",t+='<div class="viwebpos-order-detail-products">',e.each(o.line_items,(function(e,i){let s=i.image||'<img src="'+viwebpos.wc_product_placeholder+'">';t+=`<div class="viwebpos-order-detail-product-wrap" title="${i.name}">`,t+='<div class="viwebpos-order-detail-product-image">',t+='<div class="viwebpos-product-image">'+s+"</div>",t+="</div>",t+='<div class="viwebpos-order-detail-product">',t+='<div class="viwebpos-order-detail-product1">',t+='<div class="viwebpos-order-detail-product-name">'+i.name+"</div>";let l=viwebpos_get_price_html(i.subtotal,null,null,null,null,o.currency_symbol);if(i.refund_total&&0!==parseFloat(i.refund_total)){let e=parseFloat(i.refund_total),s=parseFloat(i.subtotal);s=e>0?s-e:s+e,s=viwebpos_get_price_html(s,null,null,null,null,o.currency_symbol),l=`<del><span class="amount">${l}</span></del><ins><span class="amount">${s}</span></ins>`}t+='<div class="viwebpos-order-detail-product-price">'+l+"</div>",t+="</div>",t+='<div class="viwebpos-order-detail-product2">',t+='<div class="viwebpos-order-detail-product-qty"><span>'+viwebpos_get_price_html(i.price,null,null,null,null,o.currency_symbol)+"</span> x <span>"+i.quantity+"</span></div>",i.note&&(t+='<div class="viwebpos-order-detail-product-note">'+viwebpos.transaction_table_title_note+": "+i.note+"</div>"),t+="</div></div>",t+="</div>"})),t+="</div>",t+='<div class="viwebpos-order-detail-totals">',o.note&&(t+='<div class="viwebpos-order-detail-notes">'+viwebpos.transaction_table_title_note+": "+o.note+"</div>"),t+='<div class="viwebpos-order-total-line"><div class="viwebpos-order-total-line-title">'+viwebpos.subtotal_title+"</div>",t+='<div class="viwebpos-order-total-line-value">'+viwebpos_get_price_html(o.subtotal,null,null,null,null,o.currency_symbol)+"</div></div>",t+='<div class="viwebpos-order-total-line"><div class="viwebpos-order-total-line-title">'+viwebpos.tax_title+"</div>";let a=viwebpos_get_price_html(o.total_tax,null,null,null,null,o.currency_symbol);if(o.refund_total_tax&&0!==parseFloat(o.refund_total_tax)){let e=parseFloat(o.refund_total_tax),i=parseFloat(o.total_tax);i=e>0?i-e:i+e,i=viwebpos_get_price_html(i,null,null,null,null,o.currency_symbol),a=`<del><span class="amount">${a}</span></del><ins><span class="amount">${i}</span></ins>`}if(t+='<div class="viwebpos-order-total-line-value">'+a+"</div></div>",0!==parseFloat(o.total_shipping)){let e=viwebpos_get_price_html(o.total_shipping,null,null,null,null,o.currency_symbol);if(o.refund_total_shipping&&0!==parseFloat(o.refund_total_shipping)){let i=parseFloat(o.refund_total_shipping),s=parseFloat(o.total_shipping);s=i>0?s-i:s+i,s=viwebpos_get_price_html(s,null,null,null,null,o.currency_symbol),e=`<del><span class="amount">${e}</span></del><ins><span class="amount">${s}</span></ins>`}t+='<div class="viwebpos-order-total-line"><div class="viwebpos-order-total-line-title">'+viwebpos.ship_title+"</div>",t+='<div class="viwebpos-order-total-line-value">'+e+"</div></div>"}if(""!==r&&(t+='<div class="viwebpos-order-total-line"><div class="viwebpos-order-total-line-title">'+viwebpos.discount_title+"</div>",t+='<div class="viwebpos-order-total-line-value">'+r+viwebpos_get_price_html(o.total_discount,null,null,null,null,o.currency_symbol)+"</div></div>"),o.fee_lines&&o.fee_lines.length&&e.each(o.fee_lines,(function(e,i){t+='<div class="viwebpos-order-total-line"><div class="viwebpos-order-total-line-title">'+i.title+"</div>",t+='<div class="viwebpos-order-total-line-value">'+viwebpos_get_price_html(parseFloat(i.total)+parseFloat(i.total_tax),null,null,null,null,o.currency_symbol)+"</div></div>"})),t+='<div class="viwebpos-order-total-line viwebpos-order-total-line1"><div class="viwebpos-order-total-line-title">'+viwebpos.total_title+"</div>",t+='<div class="viwebpos-order-total-line-value">'+viwebpos_get_price_html(o.total,null,null,null,null,o.currency_symbol)+"</div></div>",o.pos_payment_details&&Object.keys(o.pos_payment_details).length){let i="";e.each(o.pos_payment_details,(function(e,s){let t="";t="multi"===o.payment_details.method_id?viwebpos.viwebpos_payments&&viwebpos.viwebpos_payments[e]?viwebpos.viwebpos_payments[e].title||viwebpos.paid_title:e||viwebpos.paid_title:viwebpos.viwebpos_payments&&viwebpos.viwebpos_payments[o.payment_details.method_id]?viwebpos.viwebpos_payments[e].title:e??viwebpos.paid_title,i+='<div class="viwebpos-order-total-line viwebpos-payment-label"><div class="viwebpos-order-total-line-title">'+t+"</div>",i+='<div class="viwebpos-order-total-line-value">'+viwebpos_get_price_html(s.paid||0,null,null,null,null,o.currency_symbol)+"</div></div>"})),t+='<div class="viwebpos-order-total-line viwebpos-order-total-line1"><div class="viwebpos-order-total-line-title">'+viwebpos.paid_title+"</div>",t+='<div class="viwebpos-order-total-line-value">'+viwebpos_get_price_html(o.pos_total_paid||0,null,null,null,null,o.currency_symbol)+"</div></div>",t+=i}else{let e=o.payment_details.method_title;!e&&o.payment_details.method_id&&viwebpos.viwebpos_payments&&void 0!==viwebpos.viwebpos_payments[o.payment_details.method_id]&&(e=viwebpos.viwebpos_payments[o.payment_details.method_id].title),e||(e=o.payment_details.method_id),e||(e=viwebpos.paid_title),t+='<div class="viwebpos-order-total-line viwebpos-order-total-line1"><div class="viwebpos-order-total-line-title">'+e+"</div>",t+='<div class="viwebpos-order-total-line-value">'+viwebpos_get_price_html(parseFloat(o.pos_total_paid),null,null,null,null,o.currency_symbol)+"</div></div>"}if(t+='<div class="viwebpos-order-total-line"><div class="viwebpos-order-total-line-title">'+viwebpos.change_title+"</div>",t+='<div class="viwebpos-order-total-line-value">'+viwebpos_get_price_html(parseFloat(o.pos_change),null,null,null,null,o.currency_symbol)+"</div></div>",o.refund_total&&0!==parseFloat(o.refund_total)){let e=parseFloat(o.refund_total);t+='<div class="viwebpos-order-total-line viwebpos-order-total-refunded"><div class="viwebpos-order-total-line-title">'+viwebpos_text.refunded_title+"</div>",t+='<div class="viwebpos-order-total-line-value">'+viwebpos_get_price_html(-e,null,null,null,null,o.currency_symbol)+"</div></div>",t+='<div class="viwebpos-order-total-line viwebpos-order-total-line1"><div class="viwebpos-order-total-line-title">'+viwebpos_text.net_payment_title+"</div>",t+='<div class="viwebpos-order-total-line-value">'+viwebpos_get_price_html(o.total-e,null,null,null,null,o.currency_symbol)+"</div></div>"}t+='<div class="viwebpos-order-buttons">',t+='<button type="button" class="vi-ui button teal viwebpos-order-print viwebpos-order-button" data-order_id="'+o.id+'"><span><i class="print icon"></i></span>'+viwebpos.print_title+"</button>",t+="</div>",t+="</div>",s.html(t),o.customer_id&&s.find(".viwebpos-order-detail-header-customer").addClass("viwebpos-url").data({href:viwebpos.pos_pathname+"/customers?customer="+o.customer_id})})),e(document.body).on("viwebpos_order_refresh_html",(function(s,t="",l=1,r=20,a=!1,d=null){i&&clearTimeout(i),i=setTimeout((function(i){let s=e(document.body).triggerHandler("viwebpos_search_data",["orders",i,r,l,d??e(".viwebpos-order-type").dropdown("get value")]);e(".viwebpos-wrap").addClass("viwebpos-wrap-loading"),"function"==typeof s.then?s.then((function(e){o(e,l,i,a)})):o(s,l,i,a)}),100,t)})),e(document).on("click",".viwebpos-order-print:not(.loading)",(function(i){i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation(),e(this).addClass("loading"),e(document.body).trigger("viwebpos_print_receipt",[e(this).data("order_id")])})),e(document).on("click",".viwebpos-popup-bt-print-receipt:not(.viwebpos-popup-bt-loading)",(function(i){i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation();let o=e(this).closest(".viwebpos-popup-wrap-print-receipt"),s=e(this);e(document.body).trigger("villatheme_show_message_timeout",[e(".villatheme-show-message-message-print-receipt"),1]),o.addClass("viwebpos-popup-wrap-loading"),s.addClass("viwebpos-popup-bt-loading");let t=o.find(".viwebpos-print-receipt-order");e(document.body).trigger("viwebpos_print_receipt",[t.val(),t.data("order_data")])}))}));