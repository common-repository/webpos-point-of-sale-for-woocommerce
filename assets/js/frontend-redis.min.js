jQuery(document).ready((function(e){"use strict";if("undefined"==typeof viwebpos_redis)return!1;e(document.body).on("viwebpos_refresh_cart",(function(e){viwebpos_redis.is_update_current_cart&&viwebpos_data.is_update_current_cart&&(viwebpos_data.is_update_current_cart=!1,viwebpos_redis.is_update_current_cart=!1)})),e(document.body).on("viwebpos_redis_before_calculate_totals",(function(r,t){if(!viwebpos_redis.pd_enable&&!viwebpos_redis.cart_enable)return t;viwebpos_data.is_update_current_cart=!0,viwebpos_redis.is_update_current_cart=!0;let i,a=t.cart_contents;if(!Object.keys(a).length)return t.redis=0,t;if(void 0!==t.redis&&parseInt(t.redis)&&(e.each(t.cart_contents,(function(e,r){return!r.product_id||!r.data||(void 0===r.data.redis_old_price||void 0===r.data.redis_old_regular_price?(t.redis=0,!1):void 0)})),parseInt(t.redis)))return t;t.redis_cart_discount="",e.each(t.cart_contents,(function(e,r){if(!r.product_id||!r.data)return!0;void 0!==r.redis_old_price&&(a[e].price=r.redis_old_price),void 0!==r.data.redis_old_price&&(a[e].data.price=r.data.redis_old_price),void 0!==r.data.redis_old_regular_price&&(a[e].data.regular_price=r.data.redis_old_regular_price)})),t.cart_contents=a,t.redis=1;return async function(){let r=[];return e.each(t.cart_contents,(function(e,t){if(!t.product_id||!t.data)return!0;let i={product_id:t.product_id,variation_id:t.variation_id,quantity:t.quantity,cart_item_key:e};viwebpos.cart_change_pd_price&&void 0!==t.price?(i.only_convert=1,i.price=t.price):"custom"===t.product_id?(i.only_convert=1,i.price=t.data.price):(i.only_convert="",i.price=t.data.price),r.push(i)})),await new Promise((function(d){let c={data:r,cart_id:t.id,customer_id:t.customer&&t.customer.id||"",coupons:t.applied_coupons?Object.keys(t.applied_coupons):"",shipping_address:t.shipping&&Object.keys(t.shipping).length&&t.pos_shipping_address?t.pos_shipping_address:"",viwebpos_nonce:viwebpos.nonce};c=e(document.body).triggerHandler("viwebpos_redis_get_discount_data",c)||c,e.ajax({type:"post",url:viwebpos.viwebpos_ajax_url.toString().replace("%%endpoint%%","viwebpos_redis_get_discount"),data:c,success:function(r){"success"===r.status&&(e.each(r.pd_discount,(function(e,r){e&&a[e]&&a[e].data&&(r.only_convert&&(a[e].redis_old_price=a[e].redis_old_price||a[e].price,a[e].price=r.price),a[e].data.redis_old_price=a[e].data.redis_old_price||a[e].data.price,a[e].data.redis_old_regular_price=a[e].data.redis_old_regular_price||a[e].data.regular_price,a[e].data.price=r.price,a[e].data.regular_price=r.regular_price||a[e].data.redis_old_regular_price)})),r.cart_discount&&Object.keys(r.cart_discount).length&&(i=r.cart_discount)),a=e(document.body).triggerHandler("viwebpos_redis_get_cart_items",[a,r])||a,d(a,i)},error:function(e){console.log(e),d(a,i)}})})),t.cart_contents=a,i&&(t.redis_cart_discount=i),t}()})),e(document.body).on("viwebpos_cart_get_fees",(function(r,t,i,a=0){if(!viwebpos_redis.cart_enable||!i.redis_cart_discount)return t;let d={id:"",name:"",tax_class:"",taxable:!1,amount:0,total:0};return e.each(i.redis_cart_discount,(function(e,r){let i=d;i.name=r.title||"Redis cart discount",i.amount=parseFloat(r.amount),i.taxable=!!r.taxable,i.tax_class=r.tax_class,i.id=e,i.redis_cart_discount=1,t[i.id]=i})),t}))}));